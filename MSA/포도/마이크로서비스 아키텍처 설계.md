# 마이크로서비스 아키텍처 설계

마이크로서비스 아키텍처는 아키텍처 스타일 중 하나이다. 스타일은 아키텍처 측면의 접근 방법을 의미하며 흔히 반복적으로 사용되는 아키텍처 접근법이다.

마이크로 서비스와 마이크로 서비스 아키텍처를 구성하기 위해서는 '환경 설정 관리', '서비스 라우팅', '서비스 등록 감지', '서킷 브레이커', '메시징 시스템', 'CQRS'와 같은 기능과 이를 잘 구성하기 위한 '서비스 구성 체계', '테스트 체계', '빌드 및 배포 체계' 등이 필요하다.



## 마이크로서비스 아키텍처 구성

### 환경 설정

외부 환경 설정 관리(externalizing configuration)는 시스템에서 참조해야 하는 환경 설정 정보(환경 변수) 등을 별도의 저장소에 관리하여 애플리케이션이 배포된 환경에 구애받지 않고 해당 환경에 적절한 환경 정보들을 참조할 수 있는 기능을 제공하는 서비스이다.

환경 설정 정보 : IP, Port, 서비스명, 변수 등 

환경 정보의 변경이 발생하는 경우 이로 인해 애플리케이션이 재기동되지 않도록 런타임 중에 적용할 수 있어야 한다. 



### 서비스 등록과 감지

마이크로서비스가 시스템이 등록되는 것을 자동으로 감지하여 서비스 게이트웨이가 자동으로 인지할 수 있도록 지원하는 기능이다.



### 서비스 게이트웨이

마이크로서비스에 대한 요청을 받아 해당 요청에 필요한 서비스로 연결해 주는 역할을 한다. 즉, 서비스를 호출하기 위한 접속 채널 역할이며, 클라이언트의 요청이 한 서비스로 너무 집중되어 있을 경우에 부하를 적절히 분산하는 역할도 수행한다.



### 서킷 브레이크

특정 서비스가 정상적으로 동작하지 않을 경우 다른 기능으로 대체 수행시켜 장애를 회피한다. 따라서 사용자가 장애 상황을 인지할 수 없도록 한다.



### 큐잉 시스템

마이크로서비스 간의 데이터 전달과 느슨한 결합을 위해 사용된다. 스트림 메시지를 처리하고, 발행 및 구족 메커니즘을 지원한다.

대표적 시스템 : 카프카



### CQRS와 이벤트 소싱

CQRS(Command and Query Responsibility Segregation) : 명령을 처리하는 책임과 조회를 처리하는 책임을 분리하여 구현한다는 개념이다. 즉, 읽기를 위한 데이터 저장소아 쓰기를 위한 데이터 저장소를 분리 구성하여 쓰기 작업이 읽기 작업에 영향을 받지 않고 독립적으로 상호 수행할 수 있게 설계하는 사상이다.

이벤트 소싱 : 애플리케이션이 실행될 때 발생되는 모든 이벤트 스트림을 별도의 데이터베이스에 저장하는 방식이다. 이벤트 스트림이 저장되는 데이터베이스를 이벤트 스토어라고 하며, 저장되는 모든 이벤트 스트림 데이터는 이벤트 스토어에 추가만 된다. 애플리테이션의 상태 변경을 이력으로 관리하는 패턴의 발전된 형태라고 할 수 있다.



### 폴리그랏 프로그래밍과 폴리그랏 퍼시스턴스

폴리그랏 프로그래밍(polyglot programming) : 서비스 별로 목적과 특성에 맞는 언어와 기술을 사용하는 프로그래밍 방식이다.

폴리그랏 퍼시스턴스(polyglot persistance) : 데이터의 성격과 목적에 맞는 데이터베이스를 사용하는 방식이다. 따라서 여러 유형의 데이터베이스를 혼용하여 사용한다.



## 서비스 구성 체계

### API 버전

 API 버전은 메이저와 마이너 버전으로 구분하여 관리할 수 있다. 

메이저 버전 : 동작 방식이나 전달되는 매개변수의 변경이 발생하여 기존의 인터페이스에 대해서 대응 변경이 필요할 경우 진행한다.

마이너 버전 : 프로그램 인터페이스에 별 다른 대응 조치를 하지 않아도 되는 기존의 인터페이스를 유지하여 사용할 수 있는 변경을 의미한다.

마이크로서비스 아키텍처에서 API 버전 관리는 매우 중요하다. API 변경에 따른 장애를 사전에 방지하기 위해서는 API 체계가 일관성이 있고 명확한 기준으로 관리되어야 한다.



### REST API

WWW의 자원에 주소를 지정하고, 지정된 주소의 자원을 프로그래밍적으로 제어할 수 있도록 만든 인터페이스이다. 



### 무상태 프로토콜

마이크로서비스 간 통신 프로토콜은 무상태 프로토콜(stateless protocol)을 지향한다.

무상태 프로토콜은 클라이언트와 서버 간 통신 시에 클라이언트의 요청에 대해 서버가 응답을 보내고 나면 접속을 끊고, 서버는 클라이언트의 상태 정보를 저장하지 않는 통신 방식이다. 구조적으로 단순하고 명확하여 설계와 개발이 쉽다.

클라이언트 상태 정보를 활용하기 위해서는 쿠키나 세션을 활용한다.



## 테스트 체계 

테스트 체계는 시스템적으로 자동화되고 모니터링되어야 한다.

### 서비스 계약

서비스 생산자와 서비스 소비자 간의 거래를 뜻한다. 계약이란, 생산자가 만든 서비스를 소비자가 별더룬 문제 없이 잘 활용할 수 있도록 보장하는 매커니즘의 시스템적 명세를 뜻한다.



### API 테스트

서비스 생산자가 만든 서비스가 정상적으로 동작하는지 API 명세서를 토대로 수행해야 하는 테스트를 말한다.



### 콘트렉스 테스트

생산자와 소비자가 계약 내용이 정상적인지를 판단하는 행위를 의미한다. 

동작 원리는 다음과 같다.

1. 서비스 소비자가 서비스 계약에 필요한 명세서를 서비스 제공자의 코드에 작성한다.
2. 해당 서비스가 빌드되는 시점에 테스트 코드가 자동 생성된다. 이 코드는 단위 테스트 때 사용되고, jar 형태의 스텁 파일로 라이브러리 저장소에 업로드된다.
3. 소비자는 스텁 파일을 가져와 명세에 대한 테스트를 수행한다.
4. 서비스 소비자는 DSL이나 YAML 파일 형식으로 계약 명세서를 작성하여 서비스 생산자에게 등록한다.
5. 서비스 생산자는 명세서를 검증하여 jar 파일을 저장소에 등록하고 등록된 jar 파일을 이용하여 계약 테스트를 수행한다.



## 지속적 통합 및 배포체계 설계

마이크로서비스는 독립적으로 빌드 및 배포를 할 수 있어야 한다. 

### 지속적 통합 및 배포

개발자가 소스 코드를 저장소에 푸시하면 빌드 서버에 설치된 빌드 도구는 정해진 스케줄러에 따라 소스 코드를 빌드한다. 소스 코드가 빌드되면서 정적 분석이 수행된다. 검증된 코드는 실행 서버에서 즉시 실행 가능한 형태로 변환되어 실행 서버에 배포되어 실행된다.



### 파이프라인

마이크로서비스 별 독립적인 빌드 배포 파이프라인을 가져야 한다.



## 모니터링 체계 설계

### 서비스 모니터링

마이크로서비스 아키텍처에서는 각 개별 서비스들의 상태 정보가 모니터링되어야 한다. 각 개별 서비스로 향하는 클라이언트의 요청을 실시간으로 모니터링하여 시각화하고 개별 서비스로 향하는 클라이언트의 요청을 실시간으로 모니터링하여 시각화하여야 한다.



### 데브옵스 모니터링

서비스 기획에서 분석, 개발, 빌드, 배포, 테스트, 운영 배포까지 일련의 프로세스를 파이프라인을 형성하여 시스템적으로 자동화하는 것을 말한다.







