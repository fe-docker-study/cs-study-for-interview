# Unique ID 생성
우리는 보통 개발 시 유니크한 ID를 생성하거나 사용해야할 때가 있다. 예를들면, 일반 데이터 레코드의 PK나, 사용자 번호, 결제 번호 등등이 있을 수 있다. 

## 요구사항
보통 분산 시스템에서 ID를 생성하는 조건은 다음과 같다.

> * ID는 유일해야 한다.
> * ID는 숫자로만 구성되어야 한다.
> * ID는 64비트로 표현될 수 있는 값이어야 한다.
> * ID는 발급 날짜에 따라 정렬 가능해야 한다.
> * 초당 10,000개의 ID를 만들 수 있어야 한다.

그렇다면 유일성이 보장되는 ID값을 생성하는 방법에는 어떤 것들이 있을까?

## RDBMS의 Auto Increment
RDBMS에서 자동으로 만들어주는 자동증가 값으로 PK 용도로 사용된다. 하지만, DB 서버 한 대로는 요구를 감당할 수 없기 때문에 분산 환경에서는 이를 지속하고 latency를 낮추기 어려울 것이다. 

## 그렇다면 다른 방법들은?
분산 시스템에서 유니크한 ID를 만드는 방법들에는 여러가지가 있다.

> 다중 마스터 복제(multi-master replication)
> UUID(Universally Unique Identifier)
> 티켓 서버(ticket server)
> 트위터 스노우플레이크(twitter snowflake)

### 다중 마스터 복제
위에서 설명한 RDBMS의 auto_increment를 사용하는 방식인데, 분산환경에 적용하기 위해 **1만큼 증가시키는 것이 아닌 k만큼 증가시킨다.** (k는 현재 사용 중인 데이터베이스 서버의 수)
다음 그림을 보면 어떤 서버가 만들어 낼 다음 아이디는, 해당 서버가 생성한 이전 ID 값에 전체 서버 수 2를 더한 값이다.

#### 장점
* 구현이 간편하다.
* DB수를 늘리면 초당 생산 가능 ID수를 늘릴 수 있다.
* 순서가 보장된다.

#### 단점
* 여러 데이터 센터에 걸쳐 규모를 늘리기 어렵다.
* ID의 유일성은 보장되겠지만 그 값이 시간 흐름에 맞추어 커지도록 보장할 수는 없다.
* 서버를 추가하거나 삭제할 때도 잘 동작하기 어렵다.
* insert 되기 전에는 id 값을 알 수 없다.(DB에 의존성이 생기게 됨)

### UUID
UUID는 컴퓨터 시스템에 저장되는 정보를 유일하게 식별하기 위한 128비트짜리 수이다. 네트워크 상에서 고유성이 보장되는 ID를 만들기 위한 표준 규약이다.
8-4-4-4-12 형식으로 (ex. 09c93e62-50b4-468d-bf8a-c07e1040bfb2) 와 같은 형태를 띠며, UUID는 서버 간 조율 없이 독립적으로 생성이 가능하다. 

구조는 다음과 같다.
![img](https://user-images.githubusercontent.com/31172248/188635325-6913c1b9-0794-4d0a-8ce4-acb1e40c1a97.png)[image:242D8C13-5692-46AE-AF18-66E423EC4231-86540-00000977EF75DC28/3CEBDC5A-8857-47FE-A705-18481A2F59BD.png]

![3CEBDC5A-8857-47FE-A705-18481A2F59BD](https://user-images.githubusercontent.com/31172248/188635336-65e496d9-666c-44a9-b98d-eee1de72d0ab.png)
위 그림의 경우 각 웹서버는 별도의 ID 생성기를 사용해 독립적으로 ID를 만들어낸다.

#### 장점
* 단순하다.
* 충돌 가능성이 낮다.
* 서버 사이의 조율이 없기 때문에 동기화 이슈도 없다.
* 각 서버가 자기가 쓸 ID를 알아서 만드는 구조이기 때문에 규모 확장도 쉽다.

#### 단점
* ID가 128비트로 길다. 
* ID를 시간 순으로 정렬할 수 없다.
* ID에 숫자가 아닌 값이 포함될 수 있다.

### 티켓 서버
Flicker는 분산 기본키를 만드는데 다음과 같은 기술을 사용했다. 이 기술은 다음 그림과 같이 auto_increment 기능을 갖춘 데이터베이스 서버, 즉 티켓 서버를 중앙 집중형으로 하나만 사용한다.
[그림]

#### 장점
* 유일서이 보장되는 오직 숫자로만 구성된 ID를 쉽게 만들 수 있다.
* 구현하기 쉽고, 중소 규모 애플리케이션에 적합하다.

#### 단점
* 티켓 서버가 SPOF(Single-Point-Of-Failure)가 된다. 이 서버에 장애가 발생하면, 해당 서버를 이용하는 모든 시스템에 영향을 받는다. 



### 트위터 스노플레이크 접근법
트위터는 스노플레이크 기법을 이용해 위 방법에서 ID를 생성 시 나온 고질적 문제를 해결한다.








