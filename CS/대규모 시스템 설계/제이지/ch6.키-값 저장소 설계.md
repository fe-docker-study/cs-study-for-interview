# 키-값 저장소 설계

* 키-값 쌍의 크기는 10kb 이하
* 큰 데이터를 저장할수 있어야 함
* 높은 가용성 제공
* 높은 규모 확장성 제공
* 데이터 일관성 수준 제공 가능
* 응답 지연시간 짧음

---

## 단일 서버 키-값 저장소
한 대의 서버만 사용할 때, 가장 직관적인 방법은 키-값 쌍 전부를 메모리에 해시 테이블로 저장하는 것이다.

Q. 모든 데이터를 메모리 안에 두는 것은 불가능할 텐데 개선책은 어떤 것이 있을까?  
A. 데이터 압축을 하거나 자주 쓰이는 데이터만 메모리에 두고 나머지는 디스크에 저장한다.  
  그럼에도 한 대의 서버로 부족하다면, 분산 키-값 저장소를 쓴다

---

## 분산 키-값 저장소
분산 키-값 저장소에서, 일관성(C), 가용성(A), 파티션 감내(P) 라는 세 가지 요구사항을 동시에 만족하기란 불가능하다.

* CP 시스템 : 네트워크가 파티션되었을 때, 일관성을 유지하기 위해 다른 서버들에도 쓰기 연산을 중지시킨다.
* AP 시스템 : 네트워크가 파티션되었을 때, 가용성을 위해 낡은 데이터를 반환할 위험이 있더라도 계속 쓰기, 읽기 연산을 허용한다.
* CA 시스템 : 네트워크 장애는 불가피하므로 존재하지 않는다.

### 데이터 파티션
전체 데이터가 너무 커 한대의 서버에 넣기가 불가능할 때, 데이터를 파티션으로 분할한 다음 여러 대의 서버에 저장한다  
데이터를 여러 서버에 고르게 분산하고, 노드 추가와 삭제 시 데이터의 이동을 최소화하기 위해 안정 해시를 사용할 수 있다.  

### 데이터 다중화
데이터를 N개의 서버에 비동기적으로 다중화, 어떤 키를 해시 링 위에 대치한 후 시계 방향으로 링을 순회하며 처음 만다는 N개의 서버에 데이터 사본을 보관한다.  
가상 노드를 사용할 때에는, 노드 선택 시 같은 물리 서버를 중복으로 선택하지 않도록 한다.  

### 데이터 일관성
* N = 사본 개수
* W = 쓰기 연산에 대한 정족수
* R = 읽기 연산에 대한 정족수

Q. 각 값들은 어떻게 정해야 할까?
A. 빠른 읽기 연산에 최적화하려면 R=1, W=N,  
  빠른 쓰기 연산에 최적화하려면 W=1, R=N 로 조정한다

Q. 강한 일관성을 보장하기 위해선 어떻게 해야 할까?  
A. 모든 사본에 쓰기 연산 결과가 반영될 때까지 해당 데이터의 읽기 및 쓰기를 금지해야 한다  
그러나 이 방법으로는 고갸용성이 깨지기 때문에, W+R 을 N보다 크게 유지하면서 클라이언트 측에서 일관성 깨진 데이터를 읽지 않도록 하는 기법을 쓰는 것이 바람직하다.

### 비 일관성 해소 기법 - 데이터 버저닝
벡터 시계 : [서버, 버전]의 순서쌍을 데이터에 매달아 저장한다.

D1([Sx, 1]) > D2([Sx, 2]) > D3([Sx, 2], [Sy, 1]) - 서버 x, y에서 값 변경  
                          > D4([Sx, 2], [Sz, 1]) - 서버 z에서 값 변경  
                          > D5([Sx, 3], [Sy, 1], [Sz, 1]) - 클라이언트가 D3, D4를 동시에 읽었을 때 충돌 해소  

---
## 장애 처리
대규모 시스템에서 장애는 흔하게 벌어지는 사건이므로, 장애를 어떻게 처리할지 잘 설계 해놓는 것이 중요하다.
### 장애 감지
* 모든 노드 사이에 멀티캐스팅 채널 구축하기 : 서버가 많을 때는 비효율적이다.
* 분산형 장애 감지 (가십 프로토콜 등) : 각 서버들은 주기적으로 자신의 heartbeat counter 를 증가시키고, 그 값이 지정 시간 동안 갱신되지 않으면 장애로 간주한다.
### 일시적 장애 처리
* 엄격한 정족수 : 장애를 감지했을 때 읽기와 쓰기 연산을 금지한다
* 느슨한 정족수 : 쓰기 연산을 수행할 W개의 건강한 서버, 읽기 연산을 수행할 R개의 건강한 서버를 해시 링에서 고른다. 장애 섲버로 가는 요청은 다른 서버가 잠시 맡아 처리하고, 변경사항은 복구 시 일괄 반영한다.

### 영구 장애 처리
* 반-엔트로피 프로토콜 : 영구 서버 장애 시 사본들을 동기화
* 머클 트리 : 사본 간의 일관성이 망가진 상태를 탐지하고 전송 데이터의 양을 줄이기 위해 사용
