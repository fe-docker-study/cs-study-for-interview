# 안정 해시 설계

수평적 규모 확장성을 달성하기 위해 요청 또는 데이터를 서버에 균등하게 나누는 기술

<br>



## 해시 키 재배치(rehash) 문제

N개의 캐시 서버가 있을 때 이 서버들에 부하를 균등하게 나누는 보편적인 방법은 아래의 해시 함수를 사용하는 것이다.

serverIndex = hash(key) % N 

해당 방법은 서버 풀의 크기가 고정되어 있을 때, 데이터 분포가 균등할 때는 잘 동작한다. 하지만 서버가 추가되거나 기존 서버가 삭제되면 문제가 생긴다. 장애가 발생하면 대부분의 키가 재분배되어 캐시 클라이언트가 데이터가 없는 서버에 접속하게 된다. 결과적으로 대규모 캐시 미스가 발생하게 된다. 안정 해시는 이 문제를 해결하는 기술이다.

<br>



## 안정 해시

해시 테이블 크기가 조정될 때 평균적으로 오직 k/n의 키만 재배치하는 해시 기술

k : 키의 개수

n : 슬롯의 개수

<br>



### 해시 공간과 해시 링

SHA-1의 해시 공간 범위는 0부터 2^160 - 1까지이다. 이 해시 공간을 그리므로 표현하면 다음과 같다. 

![해시 공간](https://github.com/fe-docker-study/cs-study-for-interview/blob/main/CS/%EB%8C%80%EA%B7%9C%EB%AA%A8%20%EC%8B%9C%EC%8A%A4%ED%85%9C%20%EC%84%A4%EA%B3%84/%ED%8F%AC%EB%8F%84/%EC%82%AC%EC%A7%84/%ED%95%B4%EC%8B%9C%20%EA%B3%B5%EA%B0%84.png)

이 해시 공간의 양쪽을 구부려 접으면 다음과 같은 해시 링이 만들어진다.

![해시 링](https://github.com/fe-docker-study/cs-study-for-interview/blob/main/CS/%EB%8C%80%EA%B7%9C%EB%AA%A8%20%EC%8B%9C%EC%8A%A4%ED%85%9C%20%EC%84%A4%EA%B3%84/%ED%8F%AC%EB%8F%84/%EC%82%AC%EC%A7%84/%ED%95%B4%EC%8B%9C%20%EB%A7%81.png)

<br>



### 해시 서버

해시 함수를 사용하면 서버 IP나 이름을 해시 링  위에 대응시킬 수 있다. 해당 함수는 해시 키 재배치 문제에서 언급된 함수와는 다르다.

<br>



### 해시 키

캐시할 키 또한 해시 링 위의 어느 지점에 배치할 수 있다.

<br>



### 서버 조회

어떤 키가 저장되는 거서버는 해당 키의 위치로부터 시계 방향으로 링을 탐색해 나가면서 만나는 첫 번째 서버이다. 

<br>



### 서버 추가/제거

서버를 추가하는 경우 키 가운데 일부만 재배치하면 된다. 서버가 제거되는 경우에도 동일하다.

<br>



### 기본 구현법의 두 가지 문제

안정 해시 알고리즘은 MIT에서 처음 제안되었으며 그 기본 절차는 다음과 같다.

- 서버와 키를 균등 분포 해시 함수를 사용해 해시 링에 배치한다.
- 키의 위치에서 링을 시계 방향으로 탐색하다 만나는 최초의 서버가 키가 저장될 서버이다.



해당 접근법에는 두 가지 문제가 있다.

1. 서버가 추가되거나 삭제되는 상황을 감안하면 파티션(인접한 서버 사이의 공간)의 크기를 균등하게 유지하는 것이 불가능함
2. 키의 균등 분포를 달성하기 어려움

해당 문제를 해결하기 위해 제안된 기법이 가상 노드 또는 복제 기법이다.

<br>



### 가상 노드

가상 노드는 실제 노드 또는 서버를 가리키는 노드로서 하나의 서버는 링 위에 여러 개의 가상 노드를 가질 수 있다. 가상 노드를 사용하면 각 서버는 여러 개의 파티션을 관리해야 한다.

![가상 노드](https://github.com/fe-docker-study/cs-study-for-interview/blob/main/CS/%EB%8C%80%EA%B7%9C%EB%AA%A8%20%EC%8B%9C%EC%8A%A4%ED%85%9C%20%EC%84%A4%EA%B3%84/%ED%8F%AC%EB%8F%84/%EC%82%AC%EC%A7%84/%EA%B0%80%EC%83%81%20%EB%85%B8%EB%93%9C.png)

키의 위치로부터 시계 방향으로 링을 탐색하다 만나는 최초의 가상 노드가 해당 키가 저장될 서버가 된다. 가상 노드의 개수를 늘리면 키의 분포는 점점 더 균등해진다. 표준 편차가 작아져서 데이터가 고르게 분포되기 때문이다. 단, 가상 노드가 많아지는 경우 가상 노드 데이터를 저장할 공간은 더 많이 필요해진다.

<br>



### 재배치할 키 결정

서버가 추가되면 새로 추가된 노드부터 그 반시계 방향에 있는 첫 번째 서버 사이에 있는 키들을 새로 추가된 서버로 재배치하여야 한다. 삭제되는 경우에는 삭제된 노드부터 그 반시계 방향에 있는 최초 서버 사이에 있는 키들이 시계 방향에 있는 최초 서버로 재배치되어야 한다.

<br>



## 안정 해시의 이점

- 서버가 추가되거나 삭제될 때 재배칙치되는 키의 수가 최소화된다.
- 데이터가 보다 균등하게 분포하게 되므로 수평적 규모 확장성을 달성하기 쉽다.
- 핫스팟 키 문제를 줄인다. 특정한 샤드에 대한 접근이 지나치게 빈번하면 서버 과부하 문제가 생길 수 있는데 안정 해시는 데이터를 좀 더 균등하게 분배하기 때문에 이런 문제가 생길 가능성을 줄인다.

<br>



## 안정 해시의 예

- 아마존 다이나모 데이터베이스의 파티셔닝 관련 컴포넌트
- 아파치 카산드라 클러스터에서의 데이터 파티셔닝
- 디스코드 채팅 어플리케이션
- 아카마이 CDN
- 매크레프 네트워크 부하 분산