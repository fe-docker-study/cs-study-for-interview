# 네트워크2



## IP 패킷의 전달과 포워딩

### 전달

![Untitled](https://user-images.githubusercontent.com/90545926/152669291-ddff78ca-02a6-45a4-b290-a62a96aefc42.png)

#### 직접전달 Direct Delivery

- 같은 네트워트 안에서 패킷이 전달되거나 라우터에서 최종 목적지 호스트로 전달된 경우
- 직접 전달에서 송신자는 목적지 IP 주소를 사용해 목적지 물리주소를 찾음

#### 간접전달 Indirect Delivery

- 발신지와 목적지가 서로 다른 네트워크에 존재
- 간접전달에서 패킷은 최종 목적지에 연결된 라우터에 도달까지 여러 라우터를 경유

### 포워딩

- 패킷을 목적지로 가는 경로상에 놓는 것으로 패킷을 다음 홉으로 배달하는 것을 의미함
- 라우팅 테이블을 어떻게 구성할 것이지에 대한 개념
- IP가 비연결형 프로토콜로 사용될 때는 목적지 주소에 기반을 둔 포워딩을, 연결 지향형으로 사용될 때는 레이블에 기반을 둔 포워딩을 사용

#### 라우팅 테이블

- 라우팅 테이블에는 IP패킷을 전송하기 위한 경로가 등록
- 경로는 다음에 전송해야하는 라우터

#### 목적지 주소 기반 포워딩

- 다음-홉 : 라우팅 테이블을 가장 작게 만드는 기술로 전체 경로 대신 다음 홉 주소만 저장

- 네트워크-지정 방법 : 같은 네트워크에 연결된 모든 호스트에 대한 주소를 저장하는 대신 목적지 네트워크만을 저장

- 호스트 지정 방법 : 라우팅 테이블에 모든 목적지 주소를 저장, 관리자가 네트워크 제어 시 효과적(경로를 검사하거나 보안에서 사용)

- 디폴트 방법 : 인터넷상의 모든 네트워크 나열대신 디폴트 엔트리만 지정

  

### 라우터의 구조

#### 라우터

- 서로 독립되어 있는 이더넷 네트워크 사이에서 네트워크층 프로토콜인 IP로 양쪽의 IP패킷을 중계
- 라우터는  OSI참조 모델에서 물리층~네트워크층의 범위에서 동작하는 기기
- 한 대로 네트워크의 주요기능(DHCP, DNS, PPPoE, VPN 등)을 처리

#### 라우터 4가지 구성요소

![Untitled](https://user-images.githubusercontent.com/90545926/152669293-7e395773-83f3-4663-8ef9-66808bec4e42.png)

##### 	Input Port(입력 포트)

![Untitled](https://user-images.githubusercontent.com/90545926/152669294-f7c25273-dcd0-43e7-ace8-b35e1976d6d0.png)

- 수신된 전기 신호를 L1 프로세서가 Bit화 함
- 생성된 Bit를 L2 프로세서가 Frame으로 만들어 입력 큐에 넣음
- Decapsulation* 과정 중, 탐지된 오류는 적절한 방법으로 처리됨
- Decapsulation(역캡슐화) : TCP/IP 모델, OSI 모델에서 상위 계층의 메세지로 변환되는 것을 의미함
- Encapsulation(캡슐화) : TCP/IP 모델, OSI 모델에서 하위 계층의 메세지로 변환되는 것을 의미함

##### Output Port(출력 포트)

![Untitled](https://user-images.githubusercontent.com/90545926/152669295-0cc6e35c-9651-4c80-8b26-d00c1c443ae0.png)

- 입력 포트와 같은 기능을 반대로 수행
- 라우터로부터 출력된 IP-Datagram은 L2의 ARP 프로토콜을 통해 물리 주소로 변환됨
- 라우터로부터 출력된 패킷을 우선적으로 큐에 저장한 다음, 패킷들을 순차적으로 Encapsulation함
- 즉, 출력 포트에서는 L3 주소를 전기 신호로 변환

##### Routing Processor(라우팅 프로세서)

- L3의 기능을 수행
- 라우팅 테이블을 참조하여 Destination 주소에 매칭되는 Interface와 NHA를 얻음(Table Lookup)
- 효율성을 제고하기 위해, 라우팅 프로세싱 기능을 입력 포트로 옮기는 시도가 진행 중

##### Switching Fabric(스위칭 조직)

- 입력 큐로부터 들어온 패킷을 적절한 출력 큐로 내보내는 역할

- Crossbar Switch (크로스바 교환기), Banyan Switch (반얀 교환기) 등 라우터별로 다양한 스위칭 조직을 사용

  

## IPv4

- 직접 연결되어 있지 않은 네트워크끼리 패킷을 라우팅하는 기능을 제공하는 프로토콜. 이 동작에 따라 직접 연결 여부에 관계없이 임의의 컴퓨터와 통신할 수 있음
- IP는 호스트의 운영체제에서 동작
- IP 주소는 호스트 자체가 아니라 정확하게는 호스트의 인터페이스를 식별(PC 등은 복수의 인터페이스를 탑재할 수 있기 때문)

### IP 헤더의 포맷

![Untitled](https://user-images.githubusercontent.com/90545926/152669290-4a632ca3-9663-4c10-9ce2-207dbaf77cc7.png)

- version(4) : IPv4인지 IPv6인지 정보

- IHL(4) : 헤더길이

- Type of Service(8) : IP패킷의 우선순위를 정의(음성→ 영상 → 텍스트)

- Total Length(16) : 패킷(헤더+데이터)의 길이를 바이트 단위로 나타냄

- Identification : 각 패킷을 식별하는 번호로 패킷을 재조합할 떄 사용

- IP Flags : 패킷이 단편화되었는지 단서를 제공

  - 첫번째 비트 : 예약되어 있는 비트(항상 0)

  - 두번째 비트 : (D) : Don't Fragment? (패킷이 분할되지 않았습니까?)

    1 : 분할X /  0 : 분할O

  - 세번째 비트 : (M) : More Fragment? (분할된 패킷이 더 있습니까?)

    1 : O / 0 : X, 이게 마지막 패킷임

- Flagment Offset(13) : 패킷 재조립시 분할된 패킷간의 순서에 대한 정보

- Time to Live(8) : 패킷이 경유할 수 있는 최대 홉 수, 패킷이 라우터를 통과할때마다 1씩 감소하고 0이되면 패킷은 폐기되고 송신측으로 ICMP 메시지 전달

- Protocol(8): 상위 계층 프로토콜(ICMP, TCP, UDP 등)

- Header Checksum(16) : IP패킷 헤더의 오류 발생여부 확인

- Source Address(32) : 출발지 IP주소

- Destination Address(32) : 목적지 IP 주소

  

## ARP(Address Resolution Protocol)

- PC나 서버 등의 인터페이스는 MAC주소로 식별하기 때문에 TCP/IP의 IP주소에 대응하는 MAC 주소를 구함
- ARP 주소해석 범위는 같은 네트워크 내의 IP 주소
- 이더넷 인터페이스로 접속된 PC 등의 기기가 IP패킷을 송신하고자 목적지 IP 주소를 지정할 때 자동으로 ARP가 수행됨 IP 헤더 (목적지 IP 주소, 출발지 IP주소) → 이더넷 헤더(목적지 MAC주소, 출발지 MAC주소)

※ TCP/IP 통신에서 IP 패킷을 상대에게 보내기 위해 컴퓨터는 IP 주소내의 네트워크 주소를 보고 그 전송처를 결정한다. 이때 전송처의 네트워크 주소가 자신의 것과 동일하면 대상은 자신과 동일한 네트워크이며 물리적으로 이더넷 등에 연결되어 있다고 판단한다. 이렇게 판단하면 컴퓨터는 IP 주소에서 MAC주소를 도출하는 동작을 수행한다. 혹은 대상이 다른 네트워크에 있는 경우에는 IP 패킷을 다음 라우터로 넘겨야하는데 이때 라우터의 IP 주소에서 MAC주소를 얻을 필요가 있다. 이 동작에서 ARP라고 불리는 프로토콜이 사용된다. ARP로 IP주소에서 MAC 주소를 얻은 후에 컴퓨터는 그 MAC 주소를 전송처로 지정된 이더넷 프레임을 사용해서 IP패킷을 대상 컴퓨터로 보낸다.

### ARP 동작의 개요

1. ARP 요청을 브로드캐스트해 192.168.1.3의 MAC주소를 질의(물리적으로 연결되어 있는 컴퓨터 전체를 대상)

2. 질의받은 IP주소의 PC가 MAC 주소를 ARP응답으로 반환(각 컴퓨터는 자신의 IP와 비교해서 다르면 무시)

3. IP주소와 MAC주소의 대응을 ARP캐시에 보존

   

## ICMPv4(internet control message protocol)

- IP 동작을 보조하기 위한 특수 기능을 보유한 프로토콜. 임의의 대상에게 도달할 수 있을지 검사, 도착할 수 없는 경우의 이유를 통지하는 등에 사용
- 에러리포트 : IP 패킷이 폐기됐다면 폐기한 기기가 ICMP를 이용해 출발지로 에러리포트를 전송
- 진단기능 : IP의 엔드투엔드 통신이 가능한지 확인하는 기능(진단을 위한 명령어로 ping 커맨드가 있음,  ping 커맨드는 ICMP 에코 요청/응답 메시지를 보내 지정한 IP와 통신할 수 있는지 확인)